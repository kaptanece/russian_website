<?php
// Function to make HTTP requests
function fetch_url_content($url) {
  $user_agent = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Version/14.1.1 Safari/537.36';

  // Blacklist of disallowed URLs/IPs (this is still vulnerable as it's commented out)
  $blacklist = [
    '127.0.0.1',    // Localhost
    'localhost',
    '169.254.169.254', // AWS Metadata
    '10.0.0.0/8',   // Private network range
    '192.168.0.0/16', // Private network range
    '0.0.0.0',      // Invalid IP
  ];

  // Optional: Uncomment to block blacklisted URLs/IPs
  /*foreach ($blacklist as $blocked) {
    if (strpos($url, $blocked) !== false) {
      die("Access to this URL is forbidden for security reasons.");
    }
  }*/

  // Initialize cURL
  $options = [
    CURLOPT_URL => $url,
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_HEADER => false,
    CURLOPT_USERAGENT => $user_agent,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT => 5,
  ];

  $ch = curl_init();
  curl_setopt_array($ch, $options);

  // Execute the request
  $response = curl_exec($ch);

  // Check for errors
  if (curl_errno($ch)) {
    die("Error fetching URL: " . curl_error($ch));
  }

  curl_close($ch);
  return $response;
}

// Handling user input
if (isset($_GET['url'])) {
  $url = urldecode($_GET['url']); // Decode URL if it's URL encoded

  // For testing purposes, you can echo the URL being fetched
  echo "<p>Fetching URL: " . htmlspecialchars($url) . "</p>";

  $fetched_content = fetch_url_content($url);

  // Check if the fetched content is an image by inspecting the content type
  $finfo = finfo_open(FILEINFO_MIME_TYPE);
  $mime_type = finfo_buffer($finfo, $fetched_content);
  finfo_close($finfo);

  // If the content is an image, display it
  if (strpos($mime_type, 'image') !== false) {
    echo "<h2>Fetched Image:</h2>";
    echo "<img src='data:" . $mime_type . ";base64," . base64_encode($fetched_content) . "' />";
  } else {
    echo "<h2>Fetched Content:</h2>";
    echo "<pre>" . htmlspecialchars($fetched_content) . "</pre>";
  }
}
?>

<!DOCTYPE html>
<html>
<head>
  <title>SSRF Vulnerability Demo</title>
</head>
<body>
<h1>SSRF Vulnerability Demo</h1>
<form method="GET" action="">
  <label for="url">Enter URL to fetch:</label>
  <input type="text" name="url" id="url" placeholder="http://example.com" required>
  <button type="submit">Fetch</button>
</form>
</body>
</html>
